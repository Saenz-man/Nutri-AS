// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// üë§ PERFIL DEL NUTRI√ìLOGO
model User {
  id              String         @id @default(uuid())
  nombre          String
  apellido        String
  email           String         @unique
  password        String
  telefono        String
  carrera         String
  fechaNacimiento DateTime
  fotoPerfil      String?
  fotoBanner      String?
  status          UserStatus     @default(PENDING_PAYMENT)
  maxPatients     Int            @default(10)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  appointments    Appointment[]
  patients        Patient[]
}

// üë• EXPEDIENTE DEL PACIENTE
model Patient {
  id                     String         @id @default(uuid())
  
  // ‚úÖ CORRECCI√ìN: Se quita @unique para permitir duplicados entre diferentes nutri√≥logos
  expediente             String         
  
  nombre                 String
  apellido               String
  email                  String?
  telefono               String?
  fechaNacimiento        DateTime?
  sexo                   String?
  foto                   String?
  nutritionistId         String
  status                 PatientStatus  @default(ACTIVO)
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  talla                  Float?         @default(0)

  // üè• CAMPOS CL√çNICOS (Sincronizados con tus steps de alta)
  motivoConsulta         String?        @db.Text
  antecedentesFamiliares String[]       // Checkboxes: Diabetes, HTA, etc.
  patologicosPersonales  String[]
  cirugias               Boolean        @default(false)
  cirugiasDetalle        String?        @db.Text
  exploracion            Json?          // Hallazgos de piel, cabello, u√±as, etc.
  diagnosticoNutricional String?        @db.Text
  
  appointments           Appointment[]
  consultations          Consultation[]
  nutritionist           User           @relation(fields: [nutritionistId], references: [id])

  // ‚úÖ SOLUCI√ìN AL ERROR P2002: El expediente es √∫nico SOLO dentro del cat√°logo de un mismo nutri√≥logo
  @@unique([expediente, nutritionistId])
}

// üìÖ CITA: El eje central del Historial Cl√≠nico
model Appointment {
  id              String           @id @default(uuid())
  fechaHora       DateTime
  motivo          String?          @default("Consulta de Seguimiento")
  status          String           @default("PENDIENTE") 
  patientId       String
  nutritionistId  String
  createdAt       DateTime         @default(now())

  // üîó RELACIONES CL√çNICAS (1:1 con borrado en cascada)
  medicion        Medicion?        
  r24             R24?             
  laboratorios    Laboratorio?     
  plan            PlanAlimenticio? 

  nutritionist    User             @relation(fields: [nutritionistId], references: [id])
  patient         Patient          @relation(fields: [patientId], references: [id])
}

// üìè BLOQUE: MEDICIONES ANTROPOM√âTRICAS
model Medicion {
  id                String      @id @default(uuid())
  appointmentId     String      @unique
  appointment       Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  // üü¢ B√°sicos
  peso              Float?
  talla             Float?
  tallaSentado      Float?
  envergadura       Float?

  // üî¥ Pan√≠culos / Pliegues (mm)
  triceps           Float?
  subescapular      Float?
  biceps            Float?
  crestaIliaca      Float?
  supraespinal      Float?
  abdominal         Float?
  muslo             Float?
  piernaPaniculo    Float?    

  // üîµ Bioimpedancia
  grasaEquipo       Float?
  agua              Float?
  grasaVisceral     Float?
  edadMetabolica    Int?
  masaOsea          Float?
  musculo           Float?   // ‚úÖ % de M√∫sculo incluido

  // üîò √çndices y Circunferencias
  imc               Float?
  icc               Float?
  cintura           Float?
  cadera            Float?
  brazoR            Float?
  brazoC            Float?
  piernaCirc        Float?
  estiloideo        Float?
  femur             Float?
  humero            Float?

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

// üß™ BLOQUE: ESTUDIOS DE LABORATORIO
model Laboratorio {
  id                String      @id @default(uuid())
  appointmentId     String      @unique
  appointment       Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  // üß™ Perfil Bioqu√≠mico
  sodio             Float?
  potasio           Float?
  cloro             Float?
  bicarbonato       Float?
  coTotal           Float?
  acidoUrico        Float?
  glucosaAyuno      Float?
  glucosa1hr        Float?
  glucosa2hr        Float?
  hbGlucosilada     Float?
  creatinina        Float?
  urea              Float?
  albumina          Float?
  calcioTotal       Float?
  fosforo           Float?

  // ü•© Perfil Lip√≠dico
  colesterolTotal   Float?
  hdl               Float?
  ldl               Float?
  vldl              Float?
  trigliceridos     Float?
  lipidosTotales    Float?
  indiceAterogenico Float?

  // üöΩ Examen de Orina (EGO)
  ph                Float?
  proteinas         String?     @default("Negativo")
  glucosaOrina      String?     @default("Negativo")
  cetona            String?     @default("Negativo")
  sangre            String?     @default("Negativo")
  bilirrubina       String?     @default("Negativo")
  nitritos          String?     @default("Negativo")
  sedimento         String?     @default("Negativo")

  pdfUrl            String?
  createdAt         DateTime    @default(now())
}

// üçé BLOQUE: RECORDATORIO 24H
model R24 {
  id              String      @id @default(uuid())
  consumoKcal      Float
  notas           String?     @db.Text
  appointmentId   String      @unique
  appointment     Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
}

// ü•ó BLOQUE: PLANES ALIMENTICIOS
model PlanAlimenticio {
  id              String      @id @default(uuid())
  nombre          String
  detalles        String?     @db.Text // JSON stringificado de metas y SMAE
  appointmentId   String      @unique
  appointment     Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
}

// üìù CONSULTA: Registro r√°pido hist√≥rico
model Consultation {
  id          String   @id @default(uuid())
  fecha       DateTime @default(now())
  peso        Float
  talla       Float
  imc         Float
  subjetivo   String?  @db.Text
  objetivo    String?  @db.Text
  planAccion  String?  @db.Text
  patientId   String
  createdAt   DateTime @default(now())
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

enum UserStatus {
  PENDING_PAYMENT
  ACTIVE
  TEST_USER
}

enum PatientStatus {
  ACTIVO
  INACTIVO
}